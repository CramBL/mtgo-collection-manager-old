name: integraton-ci

on:
  pull_request:
  release:
    types: [published]
  push:
    tags:
      - master
    branches:
      - develop
      - master

env:
  VERBOSE: 1
  BUILD_MODE: Release
  MTGOPARSER_BUILD_TESTS: OFF
  MTGOPARSER_DEPLOYING_BINARY: ON

jobs:
  Test:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-22.04
            compiler: gcc-13
            enable_ipo: On

          - os: ubuntu-22.04
            compiler: llvm-17.0.2
            enable_ipo: On

          - os: macos-13
            compiler: gcc-13
            enable_ipo: Off

          - os: macos-13
            compiler: llvm-15.0.3
            enable_ipo: Off

          - os: windows-2022
            compiler: llvm-17.0.2
            enable_ipo: On


    name: Test
    steps:
      - uses: actions/checkout@v3
      - name: ðŸ—» Export constants as environment variables ðŸï¸
        uses: cardinalby/export-env-action@v2
        with:
          envFile: '.github/constants.env'
      - uses: moonrepo/setup-rust@v1
      - uses: aminya/setup-cpp@v1
        with:
          vcvarsall: ${{ contains(matrix.os, 'windows' )}}
          compiler: ${{ matrix.compiler }}
          cmake: true
          ninja: true
      - uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Setup Mold linker for Linux ðŸ§ builds
        if: runner.os == 'Linux'
        uses: rui314/setup-mold@v1

      - name: Install Task
        uses: arduino/setup-task@v1
        with:
          version: 3.x
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      - name: âš™ï¸ Install development headers - Linux ðŸ§
        if: runner.os == 'Linux'
        run: source build-util/dev-ubuntu/install-ubuntu-fltk-dev-headers.sh

      - name: âš’ï¸ Build - ðŸŽðŸ§ðŸ’»
        run: task build-integration

      - name: ðŸ“ Test - ðŸŽðŸ§ðŸ’»
        run: task test

####                                              ####
#     ðŸŽ MacOS ðŸŽ pack -> upload   ðŸŽðŸŽ            #
####                                              ####
      - name: ðŸ“¦ Pack - MacOS ðŸŽ
        if: runner.os == 'macOS'
        run: task archive-mtgo-collection-manager
        env:
          PACKAGE_NAME: macos-13-${{ matrix.compiler }}-mtgo-cm

      - name: ðŸ“© Upload - MacOS ðŸŽ
        if: runner.os == 'macOS'
        uses: actions/upload-artifact@v3
        with:
          name: macos-mtgo-collection-manager
          path: macos-13-${{ matrix.compiler }}-mtgo-cm.zip
          retention-days: 14

####                                              ####
#     ðŸ§ Linux ðŸ§ pack -> upload   ðŸ§ðŸ§            #
####                                              ####
      - name: ðŸ“¦ Pack - Linux ðŸ§
        if: runner.os == 'Linux'
        run: task archive-mtgo-collection-manager
        env:
          PACKAGE_NAME: ubuntu-22.04-${{ matrix.compiler }}-mtgo-cm

      - name: ðŸ“© Upload - Linux ðŸ§
        if: runner.os == 'Linux'
        uses: actions/upload-artifact@v3
        with:
          name: linux-mtgo-collection-manager
          path: ubuntu-22.04-${{ matrix.compiler }}-mtgo-cm.zip
          retention-days: 14

####                                              ####
#     ðŸ’» Windows ðŸ’»  pack -> upload   ðŸ’»ðŸ’»         #
####                                              ####
      - name: ðŸ“¦ Pack - Windows ðŸ’»
        if: runner.os == 'Windows'
        run: task archive-mtgo-collection-manager
        env:
          PACKAGE_NAME: windows-2022-${{ matrix.compiler }}-mtgo-cm


      - name: ðŸ“© Upload - Windows ðŸ’»
        if: runner.os == 'Windows'
        uses: actions/upload-artifact@v3
        with:
          name: windows-mtgo-collection-manager
          path: windows-2022-${{ matrix.compiler }}-mtgo-cm.zip
          retention-days: 14

